suite: test source-watcher deployment
templates:
  - source-watcher.yaml
tests:
  - it: should be empty if source-watcher is not enabled
    asserts:
      - hasDocuments:
          count: 0
    set:
      sourceWatcher.create: false
  - it: should be empty by default
    asserts:
      - hasDocuments:
          count: 0
    set: {}
  - it: should have kind Deployment for k8s >= 1.19
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      sourceWatcher.create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - isAPIVersion:
          of: apps/v1
  - it: should set additional container args
    set:
      sourceWatcher.create: true
      sourceWatcher.container.additionalArgs:
        - --testlabel1=testvalue1
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --testlabel1=testvalue1
  - it: should match snapshot with default values when enabled
    set:
      sourceWatcher.create: true
    asserts:
      - matchSnapshot: {}
  - it: should set imagePullPolicy to Always
    set:
      sourceWatcher.create: true
      sourceWatcher.imagePullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
  - it: should imagePullPolicy to be default value IfNotPresent
    set:
      sourceWatcher.create: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent
  - it: should use default cluster domain when null
    set:
      clusterDomain: null
      sourceWatcher.create: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --storage-adv-addr=source-watcher.$(RUNTIME_NAMESPACE).svc.cluster.local.
  - it: should use custom cluster domain
    set:
      sourceWatcher.create: true
      clusterDomain: custom.domain
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --storage-adv-addr=source-watcher.$(RUNTIME_NAMESPACE).svc.custom.domain.
  - it: should override securityContext
    set:
      sourceWatcher.create: true
      sourceWatcher.podSecurityContext:
        runAsUser: 2000
      sourceWatcher.securityContext:
        runAsUser: 3000
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value:
            runAsUser: 2000
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            runAsUser: 3000
  - it: should not add runAsUser if distro.openshift=true
    set:
      distro:
        openshift: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
